<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex D'ARC | ARP-PROTOCOL</title>
    <style>
        :root {
            --marinho: #0a192f;
            --azul-claro: #00b4ff;
            --azul-medio: #0077b6;
            --branco: #ffffff;
            --sucesso: #2ecc71;
            --erro: #e74c3c;
            --cinza: #e1e8ed;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f4f8; height: 100vh; display: flex; overflow: hidden; }

        .sidebar { 
            position: fixed; top: 0; left: -340px; width: 340px; height: 100%; 
            background: var(--marinho); transition: 0.4s; z-index: 1000; 
            border-right: 2px solid var(--azul-claro); color: white; overflow-y: auto;
        }
        .sidebar.open { left: 0; }
        .sidebar-header { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .aba-item { 
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; flex-direction: column; gap: 8px;
        }
        .aba-info { font-size: 11px; text-transform: uppercase; color: var(--azul-claro); font-weight: bold; }
        .aba-btns { display: flex; gap: 5px; }
        .aba-mini-btn { flex: 1; padding: 6px; font-size: 9px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-ver { background: var(--azul-medio); color: white; }
        .btn-edt { background: #555; color: white; }

        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        header { background: var(--marinho); color: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        
        main { flex: 1; overflow-y: auto; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }

        .card { background: var(--branco); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px; border-left: 6px solid var(--marinho); position: relative; }
        h2 { font-size: 13px; color: var(--marinho); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-size: 10px; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid var(--cinza); border-radius: 6px; outline: none; font-size: 14px; }
        input.campo-erro { border-color: var(--erro) !important; }

        .error-label { 
            position: absolute; top: -18px; left: 0; background: var(--erro); 
            color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; 
            display: none; z-index: 5; font-weight: bold; 
        }

        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        .check-container { margin-bottom: 15px; padding: 8px; border-radius: 8px; border: 2px solid transparent; }
        .check-row { display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
        .btn-check { flex: 1; min-width: 80px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 10px; font-weight: bold; }
        .btn-check.sim-active { border-color: var(--sucesso); color: var(--sucesso); background: #effaf3; }
        .btn-check.nao-active { border-color: var(--erro); color: var(--erro); background: #fff5f5; }

        .btn-registrar { width: 100%; padding: 15px; background: var(--marinho); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }

        #msg-parabens { display: none; text-align: center; padding: 60px 20px; transition: opacity 1s ease; }
        .view-card { display: none; background: white; padding: 25px; border-radius: 12px; border: 2px solid var(--azul-claro); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
        .overlay.active { display: block; }
        
        /* NOVO STATUS DE ENVIO */
        #loading-overlay { 
            position: fixed; inset: 0; background: rgba(10, 25, 47, 0.9); 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 2000; color: var(--azul-claro); text-align: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px; margin-bottom: 20px;">üì°</div>
        <h3 id="status-texto">SINCRONIZANDO COM O CODEX...</h3>
        <p style="font-size: 12px; margin-top: 10px; color: white;">Aguarde, o servidor est√° acordando para receber sua ficha.</p>
    </div>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 style="color: var(--azul-claro)">REGISTROS ARP</h3>
        </div>
        <div id="lista-abas"></div>
    </div>

    <div class="main-content">
        <header>
            <div style="font-size: 24px; cursor: pointer;" onclick="toggleMenu()">‚ò∞</div>
            <div style="font-weight: bold; color: var(--azul-claro);">CODEX D'ARC</div>
            <div style="font-size: 10px;">PROTOCOLO ATIVO</div>
        </header>

        <main>
            <div id="msg-parabens">
                <h1 style="color: var(--sucesso); font-size: 2.5rem;">üéâ PARAB√âNS!</h1>
                <p style="color: var(--marinho); font-size: 1.2rem; font-weight: bold;">M√ìDULO ATUALIZADO NO CODEX.</p>
            </div>

            <div class="container" id="painel-principal">
                
                <div class="card" id="card-ident">
                    <h2>üßæ IDENTIFICA√á√ÉO</h2>
                    <div class="input-group"><div class="error-label">Obrigat√≥rio</div><label>Nome Completo</label><input type="text" id="nome" class="req" onfocus="limparErro(this)"></div>
                    <div class="input-group"><div class="error-label">Obrigat√≥rio</div><label>Codinome</label><input type="text" id="cod" class="req" onfocus="limparErro(this)"></div>
                    <div class="row">
                        <div class="input-group"><label>Nascimento</label><input type="text" id="nasc" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Idade</label><input type="text" id="idade" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <div class="row">
                        <div class="input-group"><label>Naturalidade</label><input type="text" id="nat" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Nacionalidade</label><input type="text" id="nac" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <div class="row">
                        <div class="input-group"><label>Profiss√£o</label><input type="text" id="prof" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Religi√£o</label><input type="text" id="rel" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <button class="btn-registrar" onclick="salvarCard('card-ident', 'ident')">Finalizar Identifica√ß√£o</button>
                </div>

                <div class="card" id="card-fisico">
                    <h2>‚öñÔ∏è DADOS F√çSICOS</h2>
                    <div class="row">
                        <div class="input-group"><label>Altura (m)</label><input type="text" id="alt" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Peso (kg)</label><input type="text" id="peso" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <div class="row">
                        <div class="input-group"><label>Cor da Pele</label><input type="text" id="pele" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Tipo F√≠sico</label><input type="text" id="tipo" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <div class="row">
                        <div class="input-group"><label>Cor dos Olhos</label><input type="text" id="olhos" class="req" onfocus="limparErro(this)"></div>
                        <div class="input-group"><label>Cor do Cabelo</label><input type="text" id="cabelo" class="req" onfocus="limparErro(this)"></div>
                    </div>
                    <div class="input-group"><label>Marcas / Sinais</label><input type="text" id="sinais" class="req" onfocus="limparErro(this)"></div>
                    <button class="btn-registrar" onclick="salvarCard('card-fisico', 'fisico')">Finalizar Dados F√≠sicos</button>
                </div>

                <div class="card" id="card-outros">
                    <h2>üìç OUTROS DADOS</h2>
                    <div class="input-group"><label>Bairro</label><input type="text" id="bairro" class="req" onfocus="limparErro(this)"></div>
                    <div class="input-group"><label>Escolaridade</label><input type="text" id="esc" class="req" onfocus="limparErro(this)"></div>
                    <div class="check-container req-btn" id="g-pass">
                        <label>Passaporte?</label>
                        <div class="check-row">
                            <div class="btn-check" id="pass-sim" onclick="setCheck('g-pass', this, 'sim')">SIM</div>
                            <div class="btn-check" id="pass-nao" onclick="setCheck('g-pass', this, 'nao')">N√ÉO</div>
                        </div>
                    </div>
                    <div class="check-container req-btn" id="g-cnh">
                        <label>Possui CNH?</label>
                        <div class="check-row">
                            <div class="btn-check" id="cnh-sim" onclick="setCheck('g-cnh', this, 'sim')">SIM</div>
                            <div class="btn-check" id="cnh-nao" onclick="setCheck('g-cnh', this, 'nao')">N√ÉO</div>
                        </div>
                    </div>
                    <div class="input-group"><label>Categorias / Situa√ß√£o</label><input type="text" id="cnh-st" class="req" onfocus="limparErro(this)"></div>
                    <button class="btn-registrar" onclick="salvarCard('card-outros', 'outros')">Finalizar Outros Dados</button>
                </div>

                <div class="card" id="card-mob">
                    <h2>üö¶ MOBILIDADE</h2>
                    <div class="check-container req-btn" id="g-mob">
                        <label>Selecione os Transportes:</label>
                        <div class="check-row">
                            <div class="btn-check" id="m-carro" onclick="toggleMulti(this)">Carro</div>
                            <div class="btn-check" id="m-moto" onclick="toggleMulti(this)">Moto</div>
                            <div class="btn-check" id="m-bike" onclick="toggleMulti(this)">Bicicleta</div>
                            <div class="btn-check" id="m-barco" onclick="toggleMulti(this)">Barco</div>
                            <div class="btn-check" id="m-card" onclick="toggleMulti(this)">Cart√£o</div>
                        </div>
                    </div>
                    <div class="input-group"><label>Modelo e Cor do Ve√≠culo</label><input type="text" id="v-det"></div>
                    <button class="btn-registrar" id="btn-final" onclick="enviarFinal()">Finalizar Ficha ARP</button>
                </div>

            </div>

            <div class="container view-card" id="view-card"></div>
        </main>
    </div>

    <script>
        let db = {};

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function limparErro(el) {
            el.classList.remove('campo-erro');
            const label = el.parentElement.querySelector('.error-label');
            if(label) label.style.display = 'none';
        }

        function setCheck(groupId, el, tipo) {
            const group = document.getElementById(groupId);
            group.querySelectorAll('.btn-check').forEach(b => b.classList.remove('sim-active', 'nao-active', 'escolhido'));
            el.classList.add('escolhido', tipo === 'sim' ? 'sim-active' : 'nao-active');
            group.style.borderColor = "transparent";
        }

        function toggleMulti(el) {
            el.classList.toggle('sim-active');
            el.classList.toggle('escolhido');
            el.closest('.check-container').style.borderColor = "transparent";
        }

        function salvarCard(cardId, secao) {
            const card = document.getElementById(cardId);
            const inputs = card.querySelectorAll('input.req');
            const checks = card.querySelectorAll('.req-btn');
            let erro = false;

            inputs.forEach(i => {
                if(i.value.trim() === "") { i.classList.add('campo-erro'); erro = true; }
            });

            checks.forEach(c => {
                if(!c.querySelector('.escolhido')) { c.style.borderColor = "var(--erro)"; erro = true; }
            });

            if(erro) return;

            const nomeP = document.getElementById('nome').value.toUpperCase();
            db[secao] = {};
            card.querySelectorAll('input').forEach(i => { db[secao][i.id] = i.value; });
            
            db[secao].checks = [];
            card.querySelectorAll('.btn-check.escolhido').forEach(b => db[secao].checks.push(b.id));

            card.style.display = 'none';
            gerarAba(secao, nomeP);
            showParabens();
        }

        // NOVA FUN√á√ÉO DE ENVIO COM "INSIST√äNCIA" (LOOP)
        async function enviarFinal() {
            salvarCard('card-mob', 'mob');

            const loading = document.getElementById('loading-overlay');
            const statusTexto = document.getElementById('status-texto');
            loading.style.display = 'flex';
            
            const nomeAgente = document.getElementById('nome').value || "Agente Desconhecido";
            let sucesso = false;
            let tentativas = 0;

            while (!sucesso) {
                tentativas++;
                statusTexto.innerText = `CONECTANDO AO CODEX (Tentativa ${tentativas})...`;
                
                try {
                    const response = await fetch("https://codex-darc.onrender.com/registrar", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nome: nomeAgente,
                            conteudo: db
                        })
                    });

                    if (response.ok) {
                        sucesso = true;
                        loading.style.display = 'none';
                        alert("‚úÖ SUCESSO! DADOS ENVIADOS AO CODEX CENTRAL.");
                        location.reload(); // Limpa a ficha ap√≥s enviar
                    }
                } catch (err) {
                    console.log("Servidor dormindo, tentando novamente em 5 segundos...");
                    // Espera 5 segundos antes de tentar de novo
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
                
                // Limite de seguran√ßa para n√£o ficar em loop infinito se o link estiver errado
                if(tentativas > 20) {
                    alert("‚ö†Ô∏è O servidor est√° demorando muito para acordar. Tente novamente em instantes.");
                    loading.style.display = 'none';
                    break;
                }
            }
        }

        function gerarAba(secao, nome) {
            const lista = document.getElementById('lista-abas');
            let item = document.getElementById(`aba-${secao}`);
            
            if(!item) {
                item = document.createElement('div');
                item.id = `aba-${secao}`;
                item.className = 'aba-item';
                lista.appendChild(item);
            }

            item.innerHTML = `
                <div class="aba-info">üìÇ ${secao}: ${nome}</div>
                <div class="aba-btns">
                    <button class="aba-mini-btn btn-ver" onclick="verDados('${secao}')">Ver</button>
                    <button class="aba-mini-btn btn-edt" onclick="editarModulo('${secao}')">Editar</button>
                </div>
            `;
        }

        function editarModulo(secao) { fecharView(); document.getElementById('painel-principal').style.display = 'block'; document.getElementById(`card-${secao}`).style.display = 'block'; toggleMenu(); }
        function showParabens() { const msg = document.getElementById('msg-parabens'); msg.style.display = 'block'; msg.style.opacity = '1'; setTimeout(() => { msg.style.opacity = '0'; setTimeout(() => msg.style.display = 'none', 1000); }, 2000); }
        function verDados(secao) { const view = document.getElementById('view-card'); document.getElementById('painel-principal').style.display = 'none'; view.style.display = 'block'; let html = `<h3>DADOS: ${secao.toUpperCase()}</h3><br>`; for(let k in db[secao]) { if(k !== 'checks') html += `<p><b>${k}:</b> ${db[secao][k]}</p>`; } html += `<button class="btn-registrar" style="background:#555" onclick="fecharView()">FECHAR</button>`; view.innerHTML = html; toggleMenu(); }
        function fecharView() { document.getElementById('view-card').style.display = 'none'; document.getElementById('painel-principal').style.display = 'block'; }
    </script>
</body>
</html>
