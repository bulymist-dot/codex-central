<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex D'ARC | ARP-PROTOCOL</title>
    <style>
        :root {
            --marinho: #0a192f;
            --azul-claro: #00b4ff;
            --azul-medio: #0077b6;
            --branco: #ffffff;
            --sucesso: #2ecc71;
            --erro: #e74c3c;
            --cinza: #e1e8ed;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f0f4f8; height: 100vh; display: flex; overflow: hidden; }

        .sidebar { 
            position: fixed; top: 0; left: -340px; width: 340px; height: 100%; 
            background: var(--marinho); transition: 0.4s; z-index: 1000; 
            border-right: 2px solid var(--azul-claro); color: white; overflow-y: auto;
        }
        .sidebar.open { left: 0; }
        .sidebar-header { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .aba-item { 
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; flex-direction: column; gap: 8px;
        }
        .aba-info { font-size: 11px; text-transform: uppercase; color: var(--azul-claro); font-weight: bold; }
        .aba-btns { display: flex; gap: 5px; }
        .aba-mini-btn { flex: 1; padding: 6px; font-size: 9px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-ver { background: var(--azul-medio); color: white; }
        .btn-edt { background: #555; color: white; }

        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; }
        header { background: var(--marinho); color: white; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; }
        
        main { flex: 1; overflow-y: auto; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }

        .card { background: var(--branco); border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 25px; border-left: 6px solid var(--marinho); position: relative; }
        h2 { font-size: 13px; color: var(--marinho); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; font-size: 10px; font-weight: bold; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid var(--cinza); border-radius: 6px; outline: none; font-size: 14px; }
        input.campo-erro { border-color: var(--erro) !important; }

        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        .check-container { margin-bottom: 15px; padding: 8px; border-radius: 8px; border: 2px solid transparent; }
        .check-row { display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap; }
        .btn-check { flex: 1; min-width: 80px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 10px; font-weight: bold; }
        .btn-check.sim-active { border-color: var(--sucesso); color: var(--sucesso); background: #effaf3; }
        .btn-check.nao-active { border-color: var(--erro); color: var(--erro); background: #fff5f5; }

        .btn-registrar { width: 100%; padding: 15px; background: var(--marinho); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }

        #loading-overlay { 
            position: fixed; inset: 0; background: rgba(10, 25, 47, 0.95); 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 2000; color: var(--azul-claro); text-align: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px; margin-bottom: 20px;">üì°</div>
        <h3 id="status-texto">CONECTANDO AO CODEX...</h3>
        <p style="font-size: 12px; margin-top: 10px; color: white;">Aguarde, estamos acordando o servidor central.</p>
    </div>

    <div class="main-content">
        <header>
            <div style="font-size: 24px; cursor: pointer;" onclick="toggleMenu()">‚ò∞</div>
            <div style="font-weight: bold; color: var(--azul-claro);">CODEX D'ARC</div>
            <div style="font-size: 10px;">PROTOCOLO ATIVO</div>
        </header>

        <main>
            <div class="container" id="painel-principal">
                <div class="card" id="card-ident">
                    <h2>üßæ IDENTIFICA√á√ÉO</h2>
                    <div class="input-group"><label>Nome Completo</label><input type="text" id="nome" class="req"></div>
                    <div class="input-group"><label>Codinome</label><input type="text" id="cod" class="req"></div>
                    <button class="btn-registrar" onclick="salvarCard('card-ident', 'ident')">Pr√≥xima Etapa</button>
                </div>

                <div class="card" id="card-final" style="display:none;">
                    <h2>üèÅ FINALIZAR REGISTRO</h2>
                    <p>Confirme se todos os dados foram preenchidos corretamente nas abas laterais.</p>
                    <button class="btn-registrar" onclick="enviarFinal()">ARQUIVAR NO CODEX CENTRAL</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let db = {};
        const SERVIDOR = "https://codex-darc.onrender.com";

        function salvarCard(cardId, secao) {
            const card = document.getElementById(cardId);
            db[secao] = {};
            card.querySelectorAll('input').forEach(i => { db[secao][i.id] = i.value; });
            card.style.display = 'none';
            document.getElementById('card-final').style.display = 'block';
        }

        async function enviarFinal() {
            const loading = document.getElementById('loading-overlay');
            const statusTexto = document.getElementById('status-texto');
            loading.style.display = 'flex';
            
            const nomeAgente = db.ident?.nome || "Agente Desconhecido";
            
            // Formatando os dados para o seu painel
            const conteudoFormatado = `NOVA FICHA ARP\nAgente: ${nomeAgente}\nCodinome: ${db.ident?.cod}\nDados: ${JSON.stringify(db)}`;

            let sucesso = false;
            let tentativas = 0;

            while (!sucesso && tentativas < 10) {
                tentativas++;
                statusTexto.innerText = `TENTATIVA DE CONEX√ÉO ${tentativas}...`;
                
                try {
                    const res = await fetch(`${SERVIDOR}/registrar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nome: nomeAgente, conteudo: conteudoFormatado })
                    });

                    if (res.ok) {
                        sucesso = true;
                        alert("‚úÖ FICHA ARQUIVADA COM SUCESSO!");
                        location.reload();
                    }
                } catch (err) {
                    await new Promise(r => setTimeout(r, 5000)); // Espera 5 segundos para o servidor ligar
                }
            }
            if(!sucesso) {
                alert("‚ùå Erro ao conectar. Tente novamente em 1 minuto.");
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
